// Generated by CoffeeScript 1.6.3
(function() {
  var trend;

  trend = (function() {
    function trend() {}

    trend.prototype.vars = {
      base_url: "/",
      tpl_path: "public/tpl/",
      user: "anonymous",
      students: []
    };

    trend.prototype.init = function() {
      this.ui.build();
      this.listen();
      return this.login.shortpoll();
    };

    trend.prototype.listen = function() {
      var breadcrumbs, content;
      content = $('#content');
      breadcrumbs = $('#breadcrumbs');
      breadcrumbs.on('click', '#logout', function(e) {
        e.preventDefault();
        return trend.prototype.login.logout();
      });
      content.on('click', '#btn-add-student', function(e) {
        return trend.prototype.ui.dialog.show("#add-dialog");
      });
      content.on('click', 'button.close', function(e) {
        return trend.prototype.ui.dialog.hide("#add-dialog");
      });
      content.on('submit', '#login form', function(re) {
        re.preventDefault();
        return trend.prototype.login.submit($(this));
      });
      content.on('keyup', '.student span', function(e) {
        var field, id, val;
        val = $(this).text();
        field = $(this).data('fieldname');
        id = $(this).closest('tr').data('student-id');
        return $.post('op/crud.jsp', {
          "intent": "u",
          "field": field,
          "val": val,
          "id": id
        }, function(e) {
          return console.log(e);
        });
      });
      content.on('click', '.delete', function(e) {
        var id;
        id = $(this).data('student-id');
        return $.post('op/crud.jsp', {
          "intent": "d",
          id: id
        }, function(e) {
          return console.log(e);
        }).done(function() {
          trend.prototype.ui.rebuild();
          return location.reload();
        });
      });
      content.on('keydown', '#txtSearchStudents', function(e) {
        var val;
        val = $(this).val();
        return $.post('op/crud.jsp', {
          "intent": "s",
          "key": val
        }, function(e) {
          return console.log(e);
        }).done(function(re) {
          var k, student_list, tbody, v, _results;
          re = JSON.parse(re);
          student_list = $('#student-list');
          tbody = student_list.find('tbody').html("");
          _results = [];
          for (k in re) {
            v = re[k];
            _results.push(tbody.append(("<tr class='student' data-student-id='" + v.id + "'>") + ("<td><img src='" + v.profile + "'>") + ("<td><span contenteditable data-fieldname='name'>" + v.name + "</span>") + ("<td><span contenteditable data-fieldname='username'>" + v.username + "</span>") + ("<td><span contenteditable data-fieldname='address'>" + v.address + "</span>") + ("<td><span contenteditable data-fieldname='email'>" + v.email + "</span>") + ("<td><span contenteditable data-fieldname='contact'>" + v.contact + "</span>") + ("<td><a href='#' class='delete' data-student-id='" + v.id + "'><i class='icon-trash'></i></a>")));
          }
          return _results;
        });
      });
      return content.on('click', '#btn-register-student', function(e) {
        var data, form;
        e.preventDefault();
        form = $(this).closest('form');
        data = form.serializeArray();
        return $.post('op/crud.jsp', data, function(e) {
          return console.log(e);
        }).done(function() {
          trend.prototype.ui.dialog.hide('.dialog');
          trend.prototype.ui.rebuild();
          return location.reload();
        });
      });
    };

    trend.prototype.ui = {
      vars: {
        breadcrumbs: [
          {
            "location": "#login",
            "title": "Login"
          }
        ],
        page: {
          "title": "Management System for Interns",
          "icon": "icon-code-fork"
        },
        content_tpl: "login",
        view_tpl: "table"
      },
      build: function() {
        return this.rebuild();
      },
      rebuild: function() {
        var breadcrumbs, content, home, page, page_info, tpl, user_nav, vars;
        vars = this.vars;
        tpl = trend.prototype.vars.tpl_path + vars.content_tpl;
        user_nav = $('#secondary-nav');
        user_nav.find('.user').text(trend.prototype.vars.user);
        page = vars.page;
        page_info = $('.page-info');
        page_info.find('h1').html("<i class='" + page.icon + "'></i>" + page.title);
        breadcrumbs = $('#breadcrumbs').find('ul');
        home = $("<li><i class='icon-home'></i>Home</li>");
        breadcrumbs.html(home);
        $.each(vars.breadcrumbs, function(k, v) {
          return breadcrumbs.append("<li><i class='icon-angle-right'></i><a href='" + v.location + "' id='" + v.id + "'>" + v.title + "</a></li>");
        });
        content = $('#content');
        return $.get("" + tpl + ".tpl", function(html) {
          return content.html(html);
        });
      },
      dialog: {
        show: function(dialog) {
          $('.overlay').show();
          return $(dialog).show();
        },
        hide: function(dialog) {
          $('.overlay').hide();
          return $(dialog).hide();
        }
      }
    };

    trend.prototype.login = {
      shortpoll: function(data) {
        return $.get('op/session.jsp', function(e) {
          var re;
          re = JSON.parse(e);
          if (re.loggedin === true) {
            trend.prototype.ui.vars.breadcrumbs = [
              {
                "location": "#logout",
                "title": "Logout",
                "id": "logout"
              }
            ];
            trend.prototype.ui.vars.content_tpl = "template";
            trend.prototype.vars.user = re.user;
            return $.get('op/crud.jsp', {
              "intent": "r"
            }, function(re) {
              return console.log("");
            }).done(function(re) {
              var k, student_list, tbody, v, _results;
              re = JSON.parse(re);
              student_list = $('#student-list');
              tbody = student_list.find('tbody').html("");
              _results = [];
              for (k in re) {
                v = re[k];
                _results.push(tbody.append(("<tr class='student' data-student-id='" + v.id + "'>") + ("<td><img src='" + v.profile + "'>") + ("<td><span contenteditable data-fieldname='name'>" + v.name + "</span>") + ("<td><span contenteditable data-fieldname='username'>" + v.username + "</span>") + ("<td><span contenteditable data-fieldname='address'>" + v.address + "</span>") + ("<td><span contenteditable data-fieldname='email'>" + v.email + "</span>") + ("<td><span contenteditable data-fieldname='contact'>" + v.contact + "</span>") + ("<td><a href='#' class='delete' data-student-id='" + v.id + "'><i class='icon-trash'></i></a>")));
              }
              return _results;
            });
          } else {
            trend.prototype.ui.vars.content_tpl = "login";
            trend.prototype.ui.breadcrumbs = [
              {
                "location": "#login",
                "title": "Login"
              }
            ];
            return trend.prototype.vars.user = "anonymous";
          }
        }).done(function() {
          return trend.prototype.ui.rebuild();
        });
      },
      submit: function(that) {
        var data;
        data = that.serializeArray();
        return $.post("op/login.jsp", data, function(re) {
          return re = JSON.parse(re);
        }).done(function(re) {
          return trend.prototype.login.shortpoll(re);
        });
      },
      logout: function() {
        return $.get("op/logout.jsp").done(function(re) {
          return trend.prototype.login.shortpoll(re);
        });
      }
    };

    return trend;

  })();

  $(document).ready(function() {
    var app;
    app = new trend;
    return app.init();
  });

}).call(this);
